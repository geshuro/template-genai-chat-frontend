<!-- eslint-disable @angular-eslint/template/elements-content -->
<!-- eslint-disable @angular-eslint/template/label-has-associated-control -->

<div id="main-container">
  <div id="main-wrapper">
    <div id="title-container">
      <mat-icon class="section-icon">file_present</mat-icon>
      <h2 class="main-title">{{ 'FILES_TITLE_LABEL' | translate }}</h2>
    </div>

    <button mat-icon-button (click)="closeDialog()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
    <div class="container-select">
      <input
        class="input-file"
        type="file"
        accept="application/pdf"
        #fileDropRef
        id="fileDropRef"
        multiple
        (change)="fileBrowseHandler($event)" />
      <div>
        <p
          class="pdf-disclaimer"
          [innerHTML]="'FILES_PDF_DISCLAIMER' | translate"></p>
        <div id="experimental-container">
          <span
            class="pdf-disclaimer"
            [innerHTML]="'PDF_DOCS_DISCLAIMER' | translate"></span>
          <span class="experimental">Experimental</span>
          <p
            class="powered-text"
            [innerHTML]="'POWERED_BY_LABEL_DOCS' | translate"></p>
          <!-- <span class="experimental">{{
            'POWERED_BY_LABEL_DOCS' | translate
          }}</span> -->
        </div>
      </div>
      <div>
        <button
          mat-button
          (click)="openDialogCreateOrUpdateCategoyFile()"
          class="add-knowledge-button">
          <mat-icon>add</mat-icon>
          {{ 'FILES_ADD_KNOWLEDGE' | translate }}
        </button>

        <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
          <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
            <button mat-icon-button disabled class="disabled-icon"></button>
            <mat-checkbox
              class="chips-files-history checklist-leaf-node"
              [ngClass]="{
                'drop-below':
                  dragNodeExpandOverArea === 'below' &&
                  dragNodeExpandOverNode === node &&
                  dragNode !== node
              }"
              [checked]="checklistSelection.isSelected(node)"
              (change)="checklistSelection.toggle(node); filesChange = true"
              draggable="true"
              (dragstart)="handleDragStart($event, node)"
              (dragover)="handleDragOver($event, node)"
              (drop)="handleDrop($event, node)"
              (dragend)="handleDragEnd($event)"
              [disabled]="node.file.isProcessing === 'true'">
              <mat-chip-listbox
                dir="auto"
                #chipGridfile
                aria-label="Enter keywords"
                [selectable]="false"
                [disabled]="node.file.isProcessing === 'true'">
                <mat-chip-option
                  [matTooltip]="node.file?.nameFile"
                  [matTooltipPosition]="'above'"
                  (removed)="deleteFileHistory($event, node)"
                  (click)="checklistSelection.toggle(node)">
                  <div matChipAvatar>
                    @if (node.file.isProcessing === 'true') {
                      <app-spinner></app-spinner>
                    } @else {
                      <mat-icon style="color: #3498db">
                        picture_as_pdf
                      </mat-icon>
                    }
                  </div>
                  <p class="name" style="color: black">
                    {{ node.file?.nameFile }}
                  </p>
                  @if (node.file.isProcessing === 'true') {
                    <p style="color: gray">
                      {{ 'NOT_PROCESSED_LABEL' | translate }}
                    </p>
                  } @else {
                    <p style="color: gray">
                      {{ node.file.createAt | date: 'dd MMM yyyy HH:mm' }}
                      @if (viewTokens) {
                        {{
                          'Tokens: ' + (node.file.numTokens | number: '1.0-0')
                        }}
                      }
                    </p>
                  }

                  <button matChipRemove aria-label="'remove ' + file">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip-option>
              </mat-chip-listbox>
            </mat-checkbox>
          </mat-tree-node>
          <!-- This is the tree node template for expandable nodes -->
          <mat-tree-node *matTreeNodeDef="let node; when: hasChild">
            <div class="mat-tree-node">
              <button
                mat-icon-button
                matTreeNodeToggle
                [attr.aria-label]="'Toggle ' + node.file.nameFile">
                <mat-icon class="mat-icon-rtl-mirror">
                  {{
                    treeControl.isExpanded(node)
                      ? 'expand_more'
                      : 'chevron_right'
                  }}
                </mat-icon>
              </button>
              <mat-checkbox
                [ngClass]="{
                  'drop-center':
                    dragNodeExpandOverArea === 'center' &&
                    dragNodeExpandOverNode === node
                }"
                [checked]="
                  !node.empty
                    ? descendantsAllSelected(node)
                    : checklistSelection.isSelected(node)
                "
                [indeterminate]="descendantsPartiallySelected(node)"
                (change)="todoItemSelectionToggle(node); filesChange = true"
                draggable="true"
                (dragstart)="handleDragStart($event, node)"
                (dragover)="handleDragOver($event, node)"
                (drop)="handleDrop($event, node)"
                (dragend)="handleDragEnd($event)"
                ><label class="label-name" style="font-weight: bold"
                  >{{ node.file.nameFile | translate
                  }}{{ ' (' + node.file.children?.length + ')' }}</label
                ></mat-checkbox
              >

              <button
                mat-icon-button
                matTooltip="{{ 'ADD_DOCUMENT_TREE_LABEL' | translate }} {{
                  node.file.nameFile
                }}"
                (click)="addNewFileItem(node); fileDropRef.click()"
                class="untoggle-btn-left-add-tree add-file-base">
                <mat-icon>add</mat-icon>
              </button>
              <button
                mat-icon-button
                matTooltip="{{ 'FILES_EDIT_KNOWLEDGE' | translate }}"
                (click)="openDialogCreateOrUpdateCategoyFile(node)"
                class="untoggle-btn-left-add-tree add-file-base">
                <mat-icon style="font-size: 20px; height: auto">edit</mat-icon>
              </button>
              @if (node.empty && node.file.nameFile !== 'OTHERS') {
                <button
                  mat-icon-button
                  matTooltip="{{ 'DELETE_DOCUMENT_TREE_LABEL' | translate }} {{
                    node.file.nameFile
                  }}"
                  (click)="deleteCategory(node)"
                  class="untoggle-btn-left-add-tree delete-base">
                  <mat-icon style="font-size: 19px; line-height: 1.2"
                    >delete</mat-icon
                  >
                </button>
              }
            </div>
            <!-- There is inline padding applied to this div using styles.
              This padding value depends on the mat-icon-button width.  -->
            <div
              [class.example-tree-invisible]="!treeControl.isExpanded(node)"
              role="group">
              <ng-container matTreeNodeOutlet></ng-container>
            </div>
          </mat-tree-node>

          <mat-tree-node> FOOTER </mat-tree-node>
        </mat-tree>
      </div>

      <div style="height: 20px"></div>
    </div>

    <div class="container-buttons-dialog-files">
      @if (isAttachPanel) {
        <button
          mat-mini-fab
          (click)="fileDropRef.click()"
          class="untoggle-btn-left-add"
          matTooltip="{{ 'UPLOAD_FILE_BUTTON_TOOLTIP' | translate }}">
          <mat-icon>file_upload</mat-icon>
        </button>
      }

      <button
        mat-flat-button
        (click)="closeDialog()"
        [matBadge]="getChildrenSelected.length"
        matBadgePosition="above"
        matBadgeColor="accent">
        <mat-icon class="material-icons-outlined">fact_check_outlined</mat-icon>
        {{ 'SELECT_FILE_BUTTON_TEXT' | translate }}
      </button>
    </div>

    <span #emptyItem></span>
    <div style="height: 56px"></div>
  </div>
</div>
